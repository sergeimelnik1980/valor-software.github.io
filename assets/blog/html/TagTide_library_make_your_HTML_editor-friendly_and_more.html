<div class="max-w-full"><p>A couple of months ago, our customer approached me with an interesting task that
    appeared not complicated at first glance. I needed to create <strong>a simple web app with a Grammarly-like view
        based on a WYSIWYG HTML editor</strong>. This app should count different text units like paragraphs, sentences,
    words, and characters. The best thing is that despite the specifics of text source: websites, Google Docs, MS
    Office, email clients, your content will be carefully analyzed for units and displayed in a form convenient for
    perception.<br></p>
    <p>No prizes for guessing what kind of issue I faced in this case :) External content from most of the resources
        contains redundant HTML tags, which influences the correctness of calculations. Moreover, messed code makes
        testing an annoying process. So, eventually, I came up with the <strong>solution for cleaning HTML from
            unnecessary tags and polishing it for further work with text</strong>.<br></p>
    <p><strong>Table of contents:<br></strong>1. Intro part<br></p>
    <p>2. The principles of HTML code prettifying</p>
    <p>3. My solution – the TagTide library</p>
    <p>4. Approaches and use cases</p>
    <p>5. An example of Google Docs content cleanup</p>
    <p>6. Kind thanks to colleagues</p>
    <p>7. Useful links<br></p>
    <h2>The principles of HTML code prettifying</h2>
    <p>Let's think about basic steps to get <strong>"editor-friendly" HTML code</strong>. I'm going to describe the idea
        with a demonstrative example. Imagine we have a perfect code that defines paragraphs.<br></p>
    <p>The code could be the following:</p>
    <div class="w-embed">
<pre>
&lt;p>Shakespeare produced most of his known works between 1589 and 1613.&lt;/p>
&lt;p>His early plays were primarily comedies and histories and are regarded as some of
the best work produced in these genres. He then wrote mainly tragedies until 1608,
among them Hamlet, Romeo and Juliet, Othello, King Lear, and Macbeth, all considered
to be among the finest works in the English language.&lt;/p>
</pre>
    </div>
    <p>The example above contains a couple of paragraphs. The second paragraph has two sentences, and the first one –
        just one.<br></p>
    <p>Let's look at the hypothetical <strong>messy equivalent</strong> of the same content:</p>
    <div class="w-embed">
<pre>
&lt;div id="content"&gt;
  &lt;div class="sent">Shakespeare produced most of his known works between &lt;span style="color: red; font-size: 24px;">1589&lt;/span> and
       &lt;span style="color: red">1613&lt;/span>.
  &lt;/div>
  &lt;div>
    &lt;div class="sent">His early plays were primarily comedies and histories and are regarded
as some of the best work produced in these genres.&lt;/div>
    &lt;div class="sent">He then wrote mainly tragedies until 1608, among them Hamlet, Romeo
and Juliet, Othello, King Lear, and Macbeth, all considered to be among the finest works
in the English language.&lt;/div>
  &lt;div>
&lt;/div&gt;
</pre>
    </div>
    <h4>What issues this messiness brings:<br></h4>
    <p>1. <strong>Redundant root div</strong> that should be ignored.</p>
    <p>2. Since a div inside another div is correct, but a <strong>paragraph inside another paragraph</strong> is a
        mistake, it's challenging to split the text into paragraphs.</p>
    <p>3. <strong>Inline styles</strong> uglify whole text perception, but they don't even influence calculation
        quality. We should get rid of them for aesthetic reasons.<br></p><h4>Steps to editor-friendly text</h4>
    <p>Our main goal is to transform the messy text into perfect paragraphs. Let's call this kind of text
        "editor-friendly". As far as the task contains various logic, we need to split the flow into separate
        activities. Let's dig into that!</p>
    <p>The first reasonable thing is that we need to <strong>ignore root div</strong>.</p>
    <div class="w-embed">
<pre>
&lt;div class="sent">Shakespeare produced most of his known works between &lt;span style="color:
red; font-size: 24px;">1589&lt;/span> and &lt;span style="color: red">1613&lt;/span>.&lt;/div> &lt;div>&lt;div
        class="sent">His early plays were primarily comedies and histories and are regarded as some
of the best work produced in these genres.&lt;/div> &lt;div class="sent">He then wrote mainly tragedies
until 1608, among them Hamlet, Romeo and Juliet, Othello, King Lear, and Macbeth, all considered
to be among the finest works in the English language.&lt;/div>&lt;div>&lt;/div>&lt;/div>
</pre>
    </div>
    <p>Looks better. Secondly, we should flatten the second paragraph. It means we should leave <strong>only one level
        of divs</strong> (in our case – root):</p>
    <div class="w-embed">
<pre>
Shakespeare produced most of his known works between 1589 and 1613.&lt;/div> &lt;div>
His early plays were primarily comedies and histories and are regarded as
some of the best work produced in these genres. He then wrote mainly tragedies until
1608, among them Hamlet, Romeo and Juliet, Othello, King Lear, and Macbeth, all
considered to be among the finest works in the English language.&lt;/div>
</pre>
    </div>
    <p>Our text looks much better because the second paragraph looks good. But if we talk about editor-friendly HTML
        code, we should <strong>change divs</strong> <strong>to</strong> pure <strong>paragraphs</strong>:</p>
    <div class="w-embed">
<pre>
&lt;p class="sent">Shakespeare produced most of his known works between 1589 and 1613.&lt;/p>&lt;p>
His early plays were primarily comedies and histories and are regarded as some of the best
work produced in these genres. He then wrote mainly tragedies until 1608, among them Hamlet,
Romeo and Juliet, Othello, King Lear, and Macbeth, all considered to be among the finest works
in the English language.&lt;/p>
</pre>
    </div>
    <p>Looks almost perfect! We have just minor stuff left. We need to <strong>remove</strong> all redundant <strong>tag
        attributes</strong> (<strong>"class"</strong> in our case):</p>
    <div class="w-embed">
<pre>
&lt;p>Shakespeare produced most of his known works between 1589 and 1613.&lt;/p>&lt;p>
His early plays were primarily comedies and histories and are regarded as
some of the best work produced in these genres. He then wrote mainly tragedies
until 1608, among them Hamlet, Romeo and Juliet, Othello, King Lear, and
Macbeth, all considered to be among the finest works in the English language.&lt;/p>
</pre>
    </div>
    <p>That's it. We have 100% editor-friendly HTML code that contains a couple of pure paragraphs!<br></p>
    <p><strong>In conclusion, I want to summarize all provided steps that you can use as separate pattern:</strong><br>
    </p>
    <p>1. Start from a certain point in the original code. You can ignore redundant tags that aren't important
        anymore.</p>
    <p>2. Flatten the code by removing redundant inner tags. The main goal of this step is preparation for paragraph
        splitting.</p>
    <p>3. Change div tags to paragraphs.</p>
    <p>4. Remove redundant attributes.<br></p>
    <h2>Technical approaches</h2>
    <p>At the start of the project, I intended to resolve the principles above via sets of pure regular expressions. As
        you can guess, this attempt failed. Regular expressions are not friendly with deep-nested lexemes. In this case,
        by lexemes, I mean nested HTML tags and their attributes. Having thought a little, I decided to use the <a
                href="https://en.wikipedia.org/wiki/Abstract_syntax_tree" target="_blank">AST-based</a> approach because
        I shouldn't reinvent the wheel in this case. I chose the <a
                href="https://github.com/henrikjoreteg/html-parse-stringify" target="_blank">HTML-parse-stringify
            library</a> because this solution is minimalistic yet contains all the expected functionality regarding HTML
        AST processing.</p>
    <h3><strong>My solution – the TagTide library</strong></h3>
    <p>So, please, welcome <a href="https://github.com/buchslava/tag-tide" target="_blank">TagTide</a>. The main idea of
        the solution is a set of patterns you can apply anytime when you need them. Also, I suggest you apply them in
        sequence, just like the steps above.<br></p>
    <p><strong>Let's repeat the steps of the above text transformations using TagTide.</strong></p>
    <div class="w-embed">
<pre>
import &#123; TagTide } from "tag-tide";

const original = `
    &lt;div id="content">&lt;div class="sent">Shakespeare produced most of his known works
between &lt;span style="color: red; font-size: 24px;">1589&lt;/span> and &lt;span style="color: red">1613&lt;/span>.&lt;/div>
    &lt;div>&lt;div class="sent">His early plays were primarily comedies and histories and are regarded
as some of the best work produced in these genres.&lt;/div>
      &lt;div class="sent">He then wrote mainly tragedies until 1608, among them Hamlet, Romeo and Juliet,
Othello, King Lear, and Macbeth, all considered to be among the finest works in the English language.&lt;/div>&lt;div>&lt;/div>`;
const tagTide = new TagTide(original).startAfter("id", /^content/);
const startedAfter = tagTide.result();

console.log(startedAfter, "\n");

tagTide.flatten();
const flattened = tagTide.result();

console.log(flattened, "\n");

tagTide.rootParagraphs();
const paragraphs = tagTide.result();

console.log(paragraphs, "\n");

tagTide.removeAttributes();
const pureHtml = tagTide.result();

console.log(pureHtml);
</pre>
    </div>
    <p>Also, TagTide allows you to get the expected result in the shortest way <strong>handling the request in
        sequence</strong> by different objects (I use <a
            href="https://www.dofactory.com/javascript/design-patterns/chain-of-responsibility" target="_blank">a chain
        of responsibility pattern</a>):</p>
    <div class="w-embed">
<pre>
import &#123; TagTide } from "tag-tide";

const original = `
    &lt;div id="content">&lt;div class="sent">Shakespeare produced most of his known works
between &lt;span style="color: red; font-size: 24px;">1589&lt;/span> and &lt;span style="color: red">1613&lt;/span>.&lt;/div>
    &lt;div>&lt;div class="sent">His early plays were primarily comedies and histories and are regarded
as some of the best work produced in these genres.&lt;/div>
      &lt;div class="sent">He then wrote mainly tragedies until 1608, among them Hamlet, Romeo and Juliet, Othello,
King Lear, and Macbeth, all considered to be among the finest works in the English language.&lt;/div>&lt;div>&lt;/div>`;
const pureHtml = new TagTide(original).startAfter("id", /^content/).flatten().rootParagraphs().removeAttributes().result();

console.log(pureHtml);
</pre>
    </div>
    <h2>Use cases<br></h2>
    <p>There is a couple of fundamental approaches how to change your HTML code using TagTide:<br></p>
    <p>1. Direct changes via <strong>`traverse`</strong>;</p>
    <p>2. Changes via the <strong>set of patterns</strong>.<br></p>
    <p>This part contains different examples illustrating the approaches above.</p><h4><strong>Change some content in
        2nd nesting level</strong><br></h4>
    <div class="w-embed">
<pre>
import &#123; El, TagTide } from "tag-tide";

const original = "&lt;div>level 1 &lt;div>level 2 &lt;div>level 3&lt;/div>&lt;/div>&lt;/div>";
const prettified = new TagTide(original)
  .traverse((el: El, level: number) => &#123;
    if (level === 2 && el.content) &#123;
      el.content = `modified $&#123;el.content}`;
    }
  })
  .result();

console.log(prettified);
</pre>
    </div>
    <p>Output:</p>
    <div class="w-embed">
<pre>
&lt;div>level 1 &lt;div>modified level 2 &lt;div>level 3&lt;/div>&lt;/div>&lt;/div>
</pre>
    </div>
    <h4><strong>Aggregate numeric values from different nesting levels</strong></h4>
    <div class="w-embed">
<pre>
import &#123; El, TagTide } from "tag-tide";

const original = "
1
2
3
";
let total = 0;
new TagTide(original).traverse((el: El) => &#123;
    if (el.content) &#123;
    total += +el.content.trim();
  }
});

console.log(total);
</pre>
    </div>
    <p>Output:</p>
    <div class="w-embed">
<pre>
`6`
</pre>
    </div>
    <h4><strong>Strip some tags</strong></h4>
    <div class="w-embed">
<pre>
import &#123; TagTide } from "tag-tide";

const original = "&lt;div>level 1 &lt;div>&lt;a href='#'>&lt;span>level &lt;i>2&lt;/i>&lt;/span>&lt;/a> &lt;div>
level 3&lt;br>&lt;/div>&lt;/div>&lt;/div>";
const prettified = new TagTide(original)
  .result(['a', 'span', 'i', 'br']);

console.log(prettified);
</pre>
    </div>
    <p>Output:</p>
    <div class="w-embed">
<pre>
&lt;div>level 1 &lt;div>level 2 &lt;div>level 3&lt;/div>&lt;/div>&lt;/div>
</pre>
    </div>
    <h4><strong>Start after or Start from</strong><br></h4>
    <p>This pattern allows us to <strong>ignore</strong> some <strong>parent structures</strong>.</p>
    <div class="w-embed">
<pre>
import &#123; TagTide } from "tag-tide";

const source = `&lt;body>&lt;div class="container-1">&lt;p>content&lt;/p>&lt;/div>&lt;/body>`;
const result = new TagTide(source)
  .startAfter("class", /^container-\d/)
  .result();

console.log(result);
</pre>
    </div>
    <p>Output:</p>
    <div class="w-embed">
<pre>
&lt;p>content&lt;/p>
</pre>
    </div>
    <p>The following code illustrates another approach to <strong>set starter-tag</strong>. Also, a related tag can be
        included:</p>
    <div class="w-embed">
<pre>
import &#123; TagTide } from "tag-tide";

const source = `&lt;body>&lt;div class="container-1">&lt;p>content&lt;/p>&lt;/div>&lt;/body>`;
const result = new TagTide(source)
  .startFrom("class", /^container-\d/)
  .result();

console.log(result);
</pre>
    </div>
    <p>Output:</p>
    <div class="w-embed">
<pre>
&lt;div class="container-1">&lt;p>content&lt;/p>&lt;/div>
</pre>
    </div>
    <p><strong>Important notes:</strong><br></p>
    <p>1. In the "Start from" case, the result will include the associated (search) tag.</p>
    <p>2. If no matching tag is found, these patterns don't affect the result.<br></p><h4><strong>Flatten</strong><br>
    </h4>
    <p>This pattern will be useful if we need to <strong>remove nested tags</strong>.</p>
    <div class="w-embed">
<pre>
import &#123; TagTide } from "tag-tide";

const original =
  "&lt;div>1 &lt;div id='first'>2 &lt;div>&lt;span class='foo' style='color: red;'>3&lt;/span>&lt;/div>&lt;/div>&lt;/div> middle &lt;div>4 &lt;div>5&lt;/div>&lt;/div>";
const prettified = new TagTide(original).flatten().result();

console.log(prettified);
</pre>
    </div>
    <p>Output:</p>
    <div class="w-embed">
<pre>
&lt;div>1 2 3&lt;/div> middle &lt;div>4 5&lt;/div>
</pre>
    </div>
    <p>Also, you can <strong>omit any tags</strong> that you want except for those you need to keep (ex. &lt;br&gt;,
        &lt;b&gt;,etc.):</p>
    <div class="w-embed">
<pre>
import &#123; TagTide } from "tag-tide";

const original =
  "&lt;div>1 &lt;div id='first'>2 &lt;div>&lt;span class='foo' style='color: red;'>&lt;a href='1' target='_blank'>3&lt;/a>&lt;/span>&lt;/div>&lt;/div>&lt;/div> middle
&lt;div>4 &lt;div>5&lt;/div>&lt;/div>";
const prettified = new TagTide(original).flatten(['a']).result();

console.log(prettified);
</pre>
    </div>
    <p>Output:</p>
    <div class="w-embed">
<pre>
&lt;div>1 2 &lt;a href="1" target="_blank">3&lt;/a>&lt;/div> middle &lt;div>4 5&lt;/div>
</pre>
    </div>
    <h4><strong>Remove attributes</strong><br></h4>
    <p>This pattern allows removing all or some attributes through the whole content.<br></p>
    <p>In the following example, I've <strong>removed all attributes</strong>:</p>
    <div class="w-embed">
<pre>
import &#123; TagTide } from "tag-tide";

const original =
  "&lt;div>1 &lt;div id='first'>2 &lt;div>&lt;span class='foo' style='color: red;'>3&lt;/span>&lt;/div>&lt;/div>&lt;/div> middle &lt;div>4 &lt;div>5&lt;/div>&lt;/div>";
const prettified = new TagTide(original).flatten().removeAttributes().result();

console.log(prettified);
</pre>
    </div>
    <p>Output:</p>
    <div class="w-embed">
<pre>
&lt;div>1 &lt;div>2 &lt;div>&lt;span>3&lt;/span>&lt;/div>&lt;/div>&lt;/div> middle &lt;div>4 &lt;div>5&lt;/div>&lt;/div>
</pre>
    </div>
    <p>In the following example, all attributes have been removed except:<br></p>
    <p>* <strong>`id`</strong> attribute in all <strong>`span`</strong> tags</p>
    <p>* all <strong>`style`</strong> attributes</p>
    <div class="w-embed">
<pre>
import &#123; TagTide } from "tag-tide";

const original =
  "&lt;div>1 &lt;div id='first'>2 &lt;div>&lt;span id='s1' class='foo' style='color: red;'>3&lt;/span>&lt;/div>&lt;/div>&lt;/div>
middle &lt;div style='color: red;'>4 &lt;div>5&lt;/div>&lt;/div>";
const prettified = new TagTide(original).removeAttributes(&#123;'span': ['id'], '*': ['style']}).result();

console.log(prettified);
</pre>
    </div>
    <p>Output:</p>
    <div class="w-embed">
<pre>
&lt;div>1 &lt;div>2 &lt;div>&lt;span id="s1" style="color: red;">3&lt;/span>&lt;/div>&lt;/div>&lt;/div>
middle &lt;div style="color: red;">4 &lt;div>5&lt;/div>&lt;/div>
</pre>
    </div>
    <h4><strong>Root paragraphs</strong><br></h4>
    <p>We need to <strong>replace the</strong> <strong>`divs`</strong> in the first level of HTML <strong>with</strong>
        <strong>`paragraphs`</strong>. If the <strong>`plain text`</strong> appears at the <strong>`first
            level`</strong> instead of another tag, it should be enclosed in a <strong>`paragraph`</strong>.<br></p>
    <p>The following example shows how this approach works:</p>
    <div class="w-embed">
<pre>
import &#123; TagTide } from "tag-tide";

const original = "
start
 middle
finish
";
const prettified = new TagTide(original).rootParagraphs().result();

console.log(prettified);
</pre>
    </div>
    <p>Output:</p>
    <div class="w-embed">
<pre>
&lt;p>start&lt;/p>&lt;p> middle &lt;/p>&lt;p>finish&lt;/p>
</pre>
    </div>
    <h2>An example of Google Docs content cleanup<br></h2>
    <p>The icing on the cake is the case with code that I took from an <strong>actual Google Docs document</strong>. Not
        to overload this article, I placed this <a
                href="https://github.com/buchslava/tag-tide/blob/main/examples/complex.ts" target="_blank">example of
            code containing HTML&nbsp;on GitHub</a>.</p>
    <p>If you checked <a href="https://github.com/buchslava/tag-tide/blob/main/examples/complex.ts" target="_blank">the
        link</a>, I suppose you might be surprised by the volume of HTML in the document. Now let's imagine you need to
        work with the text inside. Can you see the text there, by the way? – I guess not really because of lots of trash
        tags and attributes. The most exciting thing in this story is that using the TagTide script, you can <strong>transform
            code </strong>from my example <strong>into the following HTML</strong>:<br></p>
<pre>
&lt;p> Test test test &lt;/p>&lt;p> Test test test &lt;/p>&lt;p>&lt;a href="http://www.microsoft.com">Test&lt;/a> test test&lt;/p>&lt;br/>&lt;br/>&lt;br/>&lt;p>
12 34 &lt;/p>&lt;br/>&lt;br/>&lt;ul>&lt;li>Aaa&lt;/li>&lt;li>Bbb&lt;/li>&lt;li>Ccc&lt;/li>&lt;/ul>&lt;br/>&lt;p>The end&lt;/p>
</pre>
    <p><strong>And you can repeat the same with the code taken from email clients, MS Word documents, and other
        sources!</strong></p>
    <h2>In conclusion, I want to thank:<br></h2>
    <p>- <a href="https://www.linkedin.com/in/waqas-younas/" target="_blank">Waqas Younas</a> for long and fruitful
        cooperation</p>
    <p>-&nbsp; <a href="https://github.com/HenrikJoreteg" target="_blank">Henrik Joreteg</a> for <a
            href="https://github.com/henrikjoreteg/html-parse-stringify" target="_blank">html-parse-stringify</a></p>
    <p>And in case you're interested in other solutions for text editing and processing, check my <a
            href="https://valor-software.com/articles/multi-highlighting-for-draftjs.html" target="_blank">Multi-Highlighting
        for DraftJS </a>article. There I share how I added an option to highlight paragraphs, phrases, and words in
        DraftJS with my solution written in TypeScript.</p>
    <h2>Useful links</h2>
    <ul role="list">
        <li><a href="https://valor-software.com/articles/multi-highlighting-for-draftjs.html" target="_blank">HTML-parse-stringify
            library</a> for HTML AST processing
        </li>
        <li><a href="https://github.com/buchslava/tag-tide" target="_blank">The TagTide library on GitHub</a></li>
        <li><a href="https://github.com/henrikjoreteg/html-parse-stringify" target="_blank">TagTide on npm</a></li>
        <li><a href="https://valor-software.com/articles/multi-highlighting-for-draftjs.html">Multi-Highlighting for
            DraftJS</a> - my other solution for highlighting text units in DraftJS editor<br></li>
    </ul>
</div>